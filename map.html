<!DOCTYPE html>
<meta http-equiv='cache-control' content='no-cache'> 
<meta http-equiv='expires' content='0'> 
<meta http-equiv='pragma' content='no-cache'>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Planner</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Route Planner</h1>
        <form id="route-form">
            <div class="form-group">
                <label for="currentLocation">Current Location</label>
                <input type="text" class="form-control" id="currentLocation" placeholder="Current Location" readonly>
            </div>
            <div class="form-group">
                <label for="destination">Destination</label>
                <input type="text" class="form-control" id="destination" placeholder="Destination">
            </div>
            <div class="form-group">
                <label for="timeRemaining">Time Remaining</label>
                <input type="text" class="form-control" id="timeRemaining" placeholder="Time Remaining">
            </div>
            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-primary" id="getLocation">Get GPS Location</button>
                <button type="button" class="btn btn-secondary" id="voiceInput">Voice Input</button>
                <button type="button" class="btn btn-success" id="routeNow">Route Now</button>
                <button type="button" class="btn btn-danger" id="start">Start</button>
            </div>
        </form>
        <div id="checkpoints" class="mt-5"></div>
    </div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script>
<script>

let watchID;
let checkpoints = [
    { lat: 22.396428, long: 114.109497, description: 'Checkpoint 1' },
    { lat: 22.396428, long: 114.109497, description: 'Checkpoint 2' },
    { lat: 22.396428, long: 114.109497, description: 'Checkpoint 3' },
];
let currentCheckpointIndex = 0;

document.getElementById('getLocation').addEventListener('click', function() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            document.getElementById('currentLocation').value = `${position.coords.latitude}, ${position.coords.longitude}`;
        }, function(error) {
            alert('Error occurred. Error code: ' + error.code);
        });
    } else {
        alert('Geolocation is not supported by this browser.');
    }
});

document.getElementById('voiceInput').addEventListener('click', function() {
    if (!('webkitSpeechRecognition' in window)) {
        alert('Web Speech API not supported.');
        return;
    }
    const recognition = new webkitSpeechRecognition();
    recognition.lang = 'zh-HK';
    recognition.onresult = function(event) {
        document.getElementById('destination').value = event.results[0][0].transcript;
    };
    recognition.start();
});

document.getElementById('routeNow').addEventListener('click', function() {
    const currentLocation = document.getElementById('currentLocation').value;
    const destination = document.getElementById('destination').value;
    if (!currentLocation || !destination) {
        alert('Please provide both current location and destination.');
        return;
    }
    // Here, you would call your routing API to get the route and checkpoints
    // For demonstration, let's assume we have some dummy checkpoints
    checkpoints = [
        { lat: 22.396428, long: 114.109497, description: 'Checkpoint 1' },
        { lat: 22.396428, long: 114.109497, description: 'Checkpoint 2' },
        { lat: 22.396428, long: 114.109497, description: 'Checkpoint 3' },
    ];
    const checkpointsDiv = document.getElementById('checkpoints');
    checkpointsDiv.innerHTML = '<h3>Checkpoints</h3><ul>' + checkpoints.map(cp => `<li>${cp.description}</li>`).join('') + '</ul>';
});

document.getElementById('start').addEventListener('click', function() {
    if (!navigator.geolocation) {
        alert('Geolocation is not supported by this browser.');
        return;
    }
    if (watchID) {
        navigator.geolocation.clearWatch(watchID);
    }
    watchID = navigator.geolocation.watchPosition(handlePositionUpdate, handleError, { enableHighAccuracy: true });
});

function handlePositionUpdate(position) {
    const { latitude, longitude } = position.coords;
    const currentLocation = { lat: latitude, long: longitude };

    speak(`You are currently at latitude ${latitude} and longitude ${longitude}`);

    const nextCheckpoint = checkpoints[currentCheckpointIndex];
    if (isNearCheckpoint(currentLocation, nextCheckpoint)) {
        speak(`You have reached ${nextCheckpoint.description}`);
        currentCheckpointIndex++;
        if (currentCheckpointIndex >= checkpoints.length) {
            speak('You have reached your destination.');
            navigator.geolocation.clearWatch(watchID);
        }
    } else if (isDeviating(currentLocation, nextCheckpoint)) {
        speak('You are deviating from your path. Please return to the route.');
    }
}

function handleError(error) {
    alert('Error occurred. Error code: ' + error.code);
}

function isNearCheckpoint(currentLocation, checkpoint) {
    const distance = getDistance(currentLocation, checkpoint);
    return distance < 50; // 50 meters threshold
}

function isDeviating(currentLocation, checkpoint) {
    const distance = getDistance(currentLocation, checkpoint);
    return distance > 100; // 100 meters threshold for deviation
}

function getDistance(loc1, loc2) {
    const R = 6371e3; // Earth's radius in meters
    const φ1 = loc1.lat * Math.PI / 180; // φ, λ in radians
    const φ2 = loc2.lat * Math.PI / 180;
    const Δφ = (loc2.lat - loc1.lat) * Math.PI / 180;
    const Δλ = (loc2.long - loc1.long) * Math.PI / 180;

    const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
              Math.cos(φ1) * Math.cos(φ2) *
              Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

    const d = R * c; // Distance in meters
    return d;
}

function speak(text) {
    if ('speechSynthesis' in window) {
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = 'en-US';
        window.speechSynthesis.speak(msg);
    } else {
        alert('Speech synthesis not supported in this browser.');
    }
}
</script>
</body>
</html>
