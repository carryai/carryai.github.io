<!DOCTYPE html>
<meta http-equiv='cache-control' content='no-cache'> 
<meta http-equiv='expires' content='0'> 
<meta http-equiv='pragma' content='no-cache'>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route Planner</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Route Planner</h1>
        <form id="route-form">
            <div class="form-group">
                <label for="currentLocation">Current Location</label>
                <input type="text" class="form-control" id="currentLocation" placeholder="Current Location" readonly>
            </div>
            <div class="form-group">
                <label for="destination">Destination</label>
                <input type="text" class="form-control" id="destination" placeholder="Destination">
            </div>
            <div class="d-flex justify-content-between mt-4">
                <button type="button" class="btn btn-primary" id="getLocation">Get GPS Location</button>
                <button type="button" class="btn btn-secondary" id="voiceInput">Voice Input</button>
                <button type="button" class="btn btn-success" id="routeNow">Route Now</button>
                <button type="button" class="btn btn-danger" id="start">Start</button>
            </div>
        </form>
        <div id="checkpoints" class="mt-5"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.rawgit.com/mattdiamond/Recorderjs/08e7abd9/dist/recorder.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>
    <script src="https://cdn.jsdelivr.net/npm/@googlemaps/js-api-loader@1.12.4"></script>
    <script>
        let watchID;
        let checkpoints = [];
        let currentCheckpointIndex = 0;

        document.getElementById('getLocation').addEventListener('click', function() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    document.getElementById('currentLocation').value = `${position.coords.latitude}, ${position.coords.longitude}`;
                }, function(error) {
                    alert('Error occurred. Error code: ' + error.code);
                });
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        });

        document.getElementById('voiceInput').addEventListener('click', function() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Web Speech API not supported.');
                return;
            }
            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'zh-HK';
            recognition.onresult = function(event) {
                document.getElementById('destination').value = event.results[0][0].transcript;
            };
            recognition.start();
        });

        document.getElementById('routeNow').addEventListener('click', function() {
            const currentLocation = document.getElementById('currentLocation').value.split(',').map(Number);
            const destination = document.getElementById('destination').value;

            if (!currentLocation || !destination) {
                alert('Please provide both current location and destination.');
                return;
            }

            const directionsService = new google.maps.DirectionsService();
            const directionsRenderer = new google.maps.DirectionsRenderer();

            const map = new google.maps.Map(document.createElement('div'));
            directionsRenderer.setMap(map);

            const request = {
                origin: { lat: currentLocation[0], lng: currentLocation[1] },
                destination: destination,
                travelMode: 'TRANSIT',
                transitOptions: {
                    modes: ['BUS', 'RAIL', 'TRAM', 'SUBWAY'],
                },
                provideRouteAlternatives: false,
            };

            directionsService.route(request, function(result, status) {
                if (status === 'OK') {
                    directionsRenderer.setDirections(result);
                    checkpoints = result.routes[0]
                        .legs[0].steps.map(step => ({
                        lat: step.start_location.lat(),
                        long: step.start_location.lng(),
                        description: `${step.travel_mode}: ${step.instructions}`
                    }));

                    displayCheckpoints(checkpoints);
                } else {
                    alert('Directions request failed due to ' + status);
                }
            });
        });

        function displayCheckpoints(checkpoints) {
            const checkpointsDiv = document.getElementById('checkpoints');
            checkpointsDiv.innerHTML = '';

            checkpoints.forEach((checkpoint, index) => {
                const checkpointDiv = document.createElement('div');
                checkpointDiv.className = 'checkpoint';
                checkpointDiv.innerHTML = `
                    <h5>Checkpoint ${index + 1}</h5>
                    <p>${checkpoint.description}</p>
                    <p>Location: ${checkpoint.lat}, ${checkpoint.long}</p>
                `;
                checkpointsDiv.appendChild(checkpointDiv);
            });
        }

        document.getElementById('start').addEventListener('click', function() {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }

            if (checkpoints.length === 0) {
                alert('No checkpoints available. Please route first.');
                return;
            }

            watchID = navigator.geolocation.watchPosition(function(position) {
                const currentLocation = {
                    lat: position.coords.latitude,
                    long: position.coords.longitude
                };

                const nextCheckpoint = checkpoints[currentCheckpointIndex];
                const distance = getDistance(currentLocation, nextCheckpoint);

                if (distance < 50) { // within 50 meters
                    speak(`You have reached ${nextCheckpoint.description}`);
                    currentCheckpointIndex++;
                    if (currentCheckpointIndex >= checkpoints.length) {
                        navigator.geolocation.clearWatch(watchID);
                        speak('You have reached your final destination.');
                    }
                }
            }, function(error) {
                alert('Error occurred. Error code: ' + error.code);
            });
        });

        function getDistance(loc1, loc2) {
            const R = 6371e3; // Earth's radius in meters
            const φ1 = loc1.lat * Math.PI / 180; // φ, λ in radians
            const φ2 = loc2.lat * Math.PI / 180;
            const Δφ = (loc2.lat - loc1.lat) * Math.PI / 180;
            const Δλ = (loc2.long - loc1.long) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const d = R * c; // Distance in meters
            return d;
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                const msg = new SpeechSynthesisUtterance(text);
                msg.lang = 'en-US';
                window.speechSynthesis.speak(msg);
            } else {
                alert('Speech synthesis not supported in this browser.');
            }
        }
    </script>
</body>
</html>
