<!DOCTYPE html>
<meta http-equiv='cache-control' content='no-cache'> 
<meta http-equiv='expires' content='0'> 
<meta http-equiv='pragma' content='no-cache'>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Navigation App</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding: 20px;
        }
        #map {
            height: 400px;
            width: 100%;
        }
        #checkpoints {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Navigation App</h1>
        <form>
            <div class="form-group">
                <label for="currentLocation">Current Location</label>
                <input type="text" class="form-control" id="currentLocation" readonly>
            </div>
            <div class="form-group">
                <label for="destination">Destination</label>
                <input type="text" class="form-control" id="destination">
            </div>
            <div class="form-group">
                <label for="timeRemaining">Time Remaining</label>
                <input type="text" class="form-control" id="timeRemaining" readonly>
            </div>
        </form>
        <div class="btn-group btn-group-lg" role="group">
            <button type="button" class="btn btn-primary" onclick="getCurrentLocation()">Get GPS Location</button>
            <button type="button" class="btn btn-secondary" onclick="startVoiceInput()">Voice Input</button>
            <button type="button" class="btn btn-success" onclick="generateRoute()">Route Now</button>
            <button type="button" class="btn btn-danger" onclick="startNavigation()">Start</button>
        </div>
        <div id="map"></div>
        <div id="checkpoints" class="list-group"></div>
    </div>

    <script>
        let currentLat, currentLng;
        let watchId;
        const checkpoints = [];

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    currentLat = position.coords.latitude;
                    currentLng = position.coords.longitude;
                    document.getElementById('currentLocation').value = `${currentLat}, ${currentLng}`;
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function startVoiceInput() {
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            recognition.lang = 'yue-Hant-HK'; // Cantonese language code
            recognition.start();

            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                document.getElementById('destination').value = transcript;
            };
        }

        function generateRoute() {
            // For simplicity, let's assume we have a function to generate route
            // This function should call a routing API to get the route and checkpoints
            // Here we just simulate with mock data
            checkpoints.push({ lat: currentLat + 0.01, lng: currentLng + 0.01 });
            checkpoints.push({ lat: currentLat + 0.02, lng: currentLng + 0.02 });
            checkpoints.push({ lat: currentLat + 0.03, lng: currentLng + 0.03 });

            displayCheckpoints();
        }

        function displayCheckpoints() {
            const checkpointsList = document.getElementById('checkpoints');
            checkpointsList.innerHTML = '';
            checkpoints.forEach((point, index) => {
                const listItem = document.createElement('a');
                listItem.className = 'list-group-item list-group-item-action';
                listItem.textContent = `Checkpoint ${index + 1}: ${point.lat}, ${point.lng}`;
                checkpointsList.appendChild(listItem);
            });
        }

        function startNavigation() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(onPositionUpdate);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function onPositionUpdate(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            document.getElementById('currentLocation').value = `${lat}, ${lng}`;
            const currentLocation = new google.maps.LatLng(lat, lng);

            // Check if user deviates from path
            const nearestCheckpoint = checkpoints[0];
            const checkpointLocation = new google.maps.LatLng(nearestCheckpoint.lat, nearestCheckpoint.lng);
            const distance = google.maps.geometry.spherical.computeDistanceBetween(currentLocation, checkpointLocation);

            if (distance > 50) { // Assuming 50 meters deviation is significant
                alert("You have deviated from the path!");
                // Add voice feedback for deviation
                const msg = new SpeechSynthesisUtterance('You have deviated from the path!');
                window.speechSynthesis.speak(msg);
            } else {
                const msg = new SpeechSynthesisUtterance(`Current location: ${lat}, ${lng}`);
                window.speechSynthesis.speak(msg);
            }
        }

        // Load Google Maps API
        function initMap() {
            const map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -34.397, lng: 150.644 },
                zoom: 8
            });
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD95rSqkw6pXe8BBztDXh0B101HjTksy-4&callback=initMap&libraries=geometry" async defer></script>
</body>
</html>
